#!/usr/bin/env ruby
# -*- coding: utf-8 -*-
# author:  	maxime d√©raspe
# email:	maximilien1er@gmail.com
# review:  	
# date:    	15-02-24
# version: 	0.01
# licence:  	


require 'bacterial-annotator'
require 'bacterial-comparator'


# Usage message to print to CLI
def usage

  print <<OEM

bacterial-annotator [annotate | compare] [OPTIONS]

# Choose either to annotate a genome or compare several genome annotations

  annotate  [OPTIONS]
            .. see annotate -h for OPTIONS

  compare   [OPTIONS] [all annotation directories]*
            .. see compare -h for OPTIONS

  --help/-h		Print this !

OEM

end


def usage_annotate

  print <<OEM

annotate [OPTIONS]

  // IO
    --input/-i		<fasta_file>	Provide the fasta file to annotate
    --outdir/-o		<outdir>	Output directory [default=BAnnotation]
    --force/-f		Force to overwrite the output directory

  // Dataset
    --refgenome/-g        <GBK_ID> 	Provide a Genbank file or a Gbk Accession ID.
    --guessref		Will guess the best reference genome to use for the annotation.

    --remotedb		<remote_database> [nr|refseq|swissprot]
			  Complete the annotation of remaining CDS with a remote NCBI BLAST
			  Can be very slow, better to use an external database !

    --externaldb		<proteins fasta_file>
			  Complete or do the annotation of remaining CDS with this database (a protein fasta file).
			  Fasta headers need to look similar to NCBI or EBI fasta headers, ex.:
			  >gi|385721352|gb|AFI72857.1| NDM-1 [Escherichia coli]
			  >sp|C7C422|BLAN1_KLEPN Beta-lactamase NDM-1 OS=Klebsiella pneumoniae..

  // Other options
    --pidentity		Minimum percentage identity to incorporate a CDS annotation [default=0.7]
    --minlength		Minimum contig length for annotation [default=500]

    --meta		Better for metagenome and plasmid annotations because of disparate codon usage [default=off]

OEM

end

# Parse the Options given on the CLI
def parseOptions_annotate

  options = {}

  # default options
  options[:outdir] = "BAnnotation"
  options[:pidentity] = 70
  options[:minlength] = 500
  options[:meta] = 0

  while x = ARGV.shift

    case x.downcase
    when "--input", "-i"
      options[:input] = ARGV.shift
    when "--refgenome", "-g"
      options[:refgenome] = ARGV.shift
    when "--outdir", "-o"
      options[:outdir] = ARGV.shift
    when "--force", "-f"
      options[:force] = 1
    when "--minlength"
      options[:minlength] = ARGV.shift
    when "--pidentity"
      options[:pidentity] = ARGV.shift
    when "--meta"
      options[:meta] = 1
    when "--remotedb"
      options[:remote_db] = ARGV.shift
    when "--externaldb"
      options[:external_db] = ARGV.shift
    when "--help", "-h"
      usage_annotate
      abort
    end

  end

  options

end


def usage_compare

  print <<OEM

compare [OPTIONS]

  //IO
    --outdir/-o    <output directory>
    --proc         <nb of process> Number of process to run the comparison

  //Synteny
    --pidentity    <default 0.80> Minimal percentage identity to call a syntenic protein
    --min_cov      <default 0.80> Minimal coverage for the alignment of the protein / gene

  //Alignment (MAFFT)
    --align        [dna|prot|both] by default align only proteins
    --concat       <nb of genes>  by default 0=all

  //Phylogeny (RAXML)
    --phylogeny    will build phylogenetic tree from the alignments files (pep or dna)
    --bootstrap    <nb of bootstrap> by default 100

OEM

end


# Parse the Options given on the CLI
def parseOptions_compare

  options = {}

  # default options
  options[:outdir] = "phylogenomics"
  options[:pidentity] = 0.8
  options[:min_cov] = 0.8
  options[:proc] = 2
  options[:align] = "prot"
  options[:genomes_list] = []
  options[:concat] = 0
  options[:phylogeny] = 0
  options[:bootstrap] = 100

  while x = ARGV.shift

    case x.downcase
    when "--outdir", "-o"
      options[:outdir] = ARGV.shift
    when "--pidentity"
      options[:pidentity] = ARGV.shift
    when "--min_cov"
      options[:min_cov] = ARGV.shift
    when "--proc", "-p"
      options[:proc] = ARGV.shift
    when "--align"
      options[:align] = ARGV.shift
    when "--concat"
      options[:concat] = ARGV.shift
    when "--phylogeny"
      options[:phylogeny] = 1
    when "--bootstrap"
      options[:bootstrap] = (ARGV.shift).to_i
    when "--help", "-h"
      usage_compare
      abort
    else
      options[:genomes_list] << x if File.exists? "#{x}"
    end

  end

  options

end


########
# MAIN #
########

if ARGV.size > 1

  ROOT = File.dirname(__FILE__)

  # Check for 3rd party dependencies : Prodigal, Blat, MAFFT
  system("ba_prodigal")
  system("ba_blat")
  system("ba_mafft")
  system("ba_raxml")

  options = {}
  genomes_list = []             # TODO multiple input genomes

  if ARGV[0] == "annotate"

    ARGV.shift
    options = parseOptions_annotate

    if ! File.exist? ("#{ROOT}/blat.linux")
      abort "#exiting blat is missing"
    end

    # Check Options
    if ! options.has_key? :refgenome and
       ! options.has_key? :remote_db and
       ! options.has_key? :external_db
      puts "You didn't provide a reference genome or a database for the annotation !"
    elsif ! options.has_key? :input
      puts "You didn't provide a fasta file to annotate !"
    elsif
      puts ""
    end

    bannot = BacterialAnnotator.new(options, ROOT)
    bannot.prepare_files_for_annotation
    bannot.run_annotation

  elsif ARGV[0] == "compare"

    ARGV.shift
    options = parseOptions_compare
    bcomp = BacterialComparator.new(options, ROOT)
    aln_opt = options[:align].downcase
    bcomp.mafft_aln aln_opt
    bcomp.raxml_tree aln_opt, options[:bootstrap] if options[:phylogeny] == 1

  else

    usage
    abort

  end


else
  usage
end
