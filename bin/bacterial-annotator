#!/usr/bin/env ruby
# -*- coding: utf-8 -*-
# author:  	maxime d√©raspe
# email:	maxime@deraspe.net
# review:  	
# date:    	15-02-24
# version: 	0.01
# licence:  	


require 'bacterial-annotator'


# Usage message to print to CLI
def usage

  print <<OEM

bacterial-annotator [OPTIONS] FASTA_FILE

[OPTIONS]

  --input/-i		<fasta_file>	Provide the fasta file to annotate
  --refgenome/-g	<GBK_ID>	Provide a Genbank file or a Gbk Accession ID
  --outdir/-o		<outdir>	Output directory [default=BAnnotation]

//optionals
  --minlength		Minimum contig length for annotation [default=500]
  --force/-f		Force to overwrite the output directory
  --gff			Will also generate gff annotation files

  --finish-remotedb	<remote_database> [nr|refseq|swissprot]
			Complete the annotation of remaining CDS with a remote NCBI BLAST
			Can be very slow, better to use an external database !

  --finish-externaldb	<proteins fasta_file>
			Complete the annotation of remaining CDS with this 
			database (protein fasta file) faster than remotedb.
			Fasta Header need to look something like this (NCBI or EBI) :


  --help/-h		Print this !
OEM

end

# Parse the Options given on the CLI
def parseOptions

  options = {}

  # default options
  options[:outdir] = "BAnnotation"

  while x = ARGV.shift

    case x.downcase
    when "--input", "-i"
      options[:input] = ARGV.shift
    when "--refgenome", "-g"
      options[:refgenome] = ARGV.shift
    when "--outdir", "-o"
      options[:outdir] = ARGV.shift
    when "--force", "-f"
      options[:force] = 1
    when "--gff"
      options[:gff] = 1
    when "--finish-remotedb"
      options[:remote_db] = ARGV.shift
    when "--finish-externaldb"
      options[:external_db] = ARGV.shift
    when "--help", "-h"
      usage
    end

  end

  options

end


# Main
if ARGV.size > 1

  ROOT = File.dirname(__FILE__)
  options = parseOptions

  # Check for 3rd party dependencies : Prodigal and Blat
  system("ba_prodigal")
  system("ba_blat")

  if ! File.exist? ("#{ROOT}/blat.linux")
    abort "exiting blat is missing"
  end

  if ! options.has_key? :refgenome
    puts "You didn't provide a reference genome for the annotation !"
  elsif ! options.has_key? :input
    puts "You didn't provide a fasta file to annotate !"
  end

  bannot = BacterialAnnotator.new(options[:input], options[:refgenome], ROOT, options[:outdir], options)
  bannot.prepare_files_for_annotation
  bannot.run_annotation

else
  usage
end
